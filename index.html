<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#22c55e">
    <title>Bo Jackson Card Scanner</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- Collections Sidebar -->
        <div class="collections-sidebar">
            <div class="collections-header">
                <div class="collections-title">üìÅ Collections</div>
                <button class="btn-new-collection" onclick="createNewCollection()">+</button>
            </div>
            
            <div class="collection-list" id="collectionList"></div>
            
            <div class="export-section">
                <div class="export-section-title">Export</div>
                <div class="export-buttons">
                    <button class="btn-export" onclick="exportCurrentCSV()">
                        <span>üìÑ</span>
                        <span>Current CSV</span>
                    </button>
                    <button class="btn-export" onclick="exportAllCSV()">
                        <span>üìö</span>
                        <span>All CSVs</span>
                    </button>
                    <button class="btn-export primary" onclick="exportExcel()">
                        <span>üìä</span>
                        <span>Excel (All Tabs)</span>
                    </button>
                </div>
            </div>
            
            <!-- Drive Export Section (shows when signed in) -->
            <div id="driveExportSection" class="drive-export-section hidden">
                <div class="export-section-title" style="margin-top: 12px;">‚òÅÔ∏è Save to Drive</div>
                <div class="export-buttons">
                    <button class="btn-export" onclick="exportToDriveCSV()">
                        <span>‚òÅÔ∏è</span>
                        <span>Current to Drive</span>
                    </button>
                    <button class="btn-export primary" onclick="exportToDriveExcel()">
                        <span>‚òÅÔ∏è</span>
                        <span>Excel to Drive</span>
                    </button>
                    <button class="btn-export" onclick="loadCollectionsFromDrive()">
                        <span>üì•</span>
                        <span>Load from Drive</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h1>
                    <span>üé¥</span>
                    <span>Card Scanner</span>
                </h1>
                <div class="subtitle">Smart OCR + AI Detection</div>
                <div class="current-collection-badge" id="currentCollectionBadge">Default Collection</div>
                
                <!-- Google Sign-In Section -->
                <div class="google-auth-section">
                    <div id="googleSignInBtn"></div>
                    
                    <div id="googleUserInfo" class="google-user-info hidden">
                        <img id="userAvatar" class="user-avatar" src="" alt="User">
                        <div class="user-details">
                            <div id="userName" class="user-name"></div>
                            <div id="userEmail" class="user-email"></div>
                        </div>
                        <button id="googleSignOutBtn" class="btn-sign-out hidden" onclick="signOut()">
                            Sign Out
                        </button>
                    </div>
                </div>
                
                <div class="status-bar">
                    <div>
                        <div class="status-dot" id="statusDb"></div>
                        <div class="status-label">DB</div>
                    </div>
                    <div>
                        <div class="status-dot" id="statusOcr"></div>
                        <div class="status-label">OCR</div>
                    </div>
                    <div>
                        <div class="status-dot" id="statusCv"></div>
                        <div class="status-label">CV</div>
                    </div>
                </div>
            </div>

            <!-- User Limits Banner -->
            <div id="userLimits"></div>

            <div class="stats-bar hidden" id="statsBar">
                <div class="stat">
                    <div class="stat-value" style="color: var(--primary);" id="statFree">0</div>
                    <div class="stat-label">FREE</div>
                </div>
                <div class="stat">
                    <div class="stat-value" style="color: var(--secondary);" id="statPaid">0</div>
                    <div class="stat-label">PAID</div>
                </div>
                <div class="stat">
                    <div class="stat-value" style="color: var(--warning);" id="statCost">$0</div>
                    <div class="stat-label">COST</div>
                </div>
                <div class="stat">
                    <div class="stat-value" style="color: #8b5cf6;" id="statRate">0%</div>
                    <div class="stat-label">FREE RATE</div>
                </div>
            </div>

            <div class="upload-area" id="uploadArea">
                <input type="file" id="fileInput" multiple accept="image/*">
                <div class="upload-icon">üì∏</div>
                <div class="upload-title">Upload or Capture</div>
                <div class="upload-subtitle">Choose from gallery or take photo</div>
                
                <!-- Mobile action buttons -->
                <div class="upload-actions" id="uploadActions">
                    <button class="upload-action-btn" onclick="capturePhoto(event)">
                        üì∑ Take Photo
                    </button>
                    <button class="upload-action-btn" onclick="chooseFromGallery(event)">
                        üñºÔ∏è Choose Image
                    </button>
                </div>
            </div>

            <div class="action-bar hidden" id="actionBar"></div>

            <div class="cards-grid" id="cardsGrid"></div>

            <div class="empty-state" id="emptyState">
                <div style="font-size: 48px; margin-bottom: 12px;">üì∑</div>
                <div style="font-size: 14px; font-weight: 600; color: var(--gray-600);">No cards yet</div>
                <div style="font-size: 12px; color: var(--gray-400); margin-top: 4px;">Tap above to start</div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-card">
            <div class="spinner"></div>
            <div class="loading-text" id="loadingText">Processing...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>
    </div>

    <div class="modal" id="collectionNameModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="collectionModalTitle">New Collection</div>
                <div class="modal-close" onclick="closeCollectionModal()">√ó</div>
            </div>
            <input type="text" class="modal-input" id="collectionNameInput" placeholder="Collection name...">
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeCollectionModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveCollectionName()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Settings</div>
                <div class="modal-close" onclick="closeSettings()">√ó</div>
            </div>
            
            <div class="setting-group">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div class="setting-label">Auto Detection</div>
                        <div class="setting-desc">Crop card automatically</div>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" id="toggleAutoDetect" checked onchange="updateSetting('autoDetect', this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="setting-group">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div class="setting-label">Perspective Fix</div>
                        <div class="setting-desc">Straighten angled photos</div>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" id="togglePerspective" checked onchange="updateSetting('perspective', this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="setting-group">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div class="setting-label">Region OCR</div>
                        <div class="setting-desc">Faster, targeted scanning</div>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" id="toggleRegionOcr" checked onchange="updateSetting('regionOcr', this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="setting-group">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div class="setting-label">Batch Scanning</div>
                        <div class="setting-desc">Detect multiple cards in one image</div>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" id="toggleBatchScan" checked onchange="updateSetting('batchScanEnabled', this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <button class="btn btn-secondary" style="margin-top: 8px; width: 100%;" onclick="showBatchGuide()">
                    üìñ How to Batch Scan
                </button>
            </div>
            
            <div class="setting-group">
                <div class="setting-label">Image Quality</div>
                <select id="selectQuality" onchange="updateSetting('quality', this.value)">
                    <option value="0.5">Low (Fastest)</option>
                    <option value="0.7" selected>Medium</option>
                    <option value="0.9">High (Best)</option>
                </select>
            </div>
            
            <div class="setting-group">
                <div class="setting-label">OCR Threshold: <span id="thresholdValue">60</span>%</div>
                <input type="range" id="rangeThreshold" min="20" max="80" value="60" 
                       oninput="document.getElementById('thresholdValue').textContent = this.value; updateSetting('threshold', this.value)">
                <div class="setting-desc">Lower = more AI fallbacks (try 20% for free scans)</div>
            </div>
            
            <button class="btn btn-secondary" style="width: 100%;" onclick="resetSettings()">
                Reset Defaults
            </button>
        </div>
    </div>

    <div class="toast" id="toast">
        <span class="toast-icon" id="toastIcon">‚úì</span>
        <span class="toast-message" id="toastMessage"></span>
    </div>

    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://docs.opencv.org/4.5.2/opencv.js" async></script>
    
    <!-- App JavaScript Modules -->
    <script src="js/config.js"></script>
    <script src="js/state.js"></script>
    <script src="js/collections.js"></script>
    <script src="js/database.js"></script>
    <script src="js/ocr.js"></script>
    <script src="js/opencv.js"></script>
    <script src="js/api.js"></script>
    <script src="js/scanner.js"></script>
    <script src="js/export.js"></script>
    <script src="js/statistics.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/google-auth.js"></script>
    <script src="js/user-management.js"></script>
    <script src="js/admin-dashboard.js"></script>
    <script src="js/batch-scanner.js"></script>
    <script src="js/app.js"></script>
</body>
</html>
